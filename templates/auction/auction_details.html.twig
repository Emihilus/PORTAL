{% extends 'base.html.twig' %}

{% block title %}Aukcja pieca {{auction.title}}{% endblock %}



{% block body %}

<div class="container">
{# modal for notify user is not logged in #}
	{% if not app.user %}
    {{ include('parts/include/ht_modal_not_logged_in.twig')  }}
	{% endif %}

<h1>Aukcja pieca {{auction.title}}</h1>
<BR>

<img src="{{asset (fip~auction.images[0].filename)}}" alt='jakialt' width="300">
{# {{ exampleVariableHijack }}   #}

<h2> ENDS AT {{auction.endsAt|date('H:m:s d-m-Y')}} </h2>
{# <h2> ENDS knplabs {{auction.endsAt | ago}} </h2>
<h2> ENDS raw: {{auction.endsAt | date('U')}} <div id='time'></div> </h2> #}
<h2> ENDS TIMER: <span class="text-success" id='timer'></span> </h2>

<h2> ISSUED BY: <a href="{{path('profile-details', {'username': auction.byUser})}}">{{auction.byUser}}</a></h2>

<p>{{auction.description}}</p>

<br>

<form id='offerForm'>
<input id='offerInput' required="required" type="number" min="{% if auction.offers|length > 0 %}{{ auction.offers[0].value/100+1 }}{% else %}{{v_offer_value_min}}{% endif %}" 
max="{{validation_maxValue/100}}" maxLength="{{validation_maxValue|length+1}}" step="any" value="{% if auction.offers|length > 0 %}{{ auction.offers[0].value/100+1 }}{% else %}{{v_offer_value_min}}{% endif %}"/> PLN  <button class="btn-primary btn" type='submit' >Offer</button>
{# onclick='makeOffer()' #}
</form>

<div id='backendErrors'></div>
<div id='offers'>

{% if auction.offers|length == 0 %}There are no offers yet{% endif %}

{% for offer in auction.offers %}
    <b>{{offer.byUser.username}} offers {{offer.value/100}} PLN</b> offered at {{offer.createdAt|date('H:m:s d-m-Y')}} <br>
{% endfor %}
</div>
<hr>







 <div class="row">
 <div><h2 class='d-inline-block'>Comments</h2><h3 class='float-end'>45 comments</h3></div>

    <div class="list-group-item-dark rounded p-3">
        <small class='float-end'> 5 days ago </small>
        <div>
        <b>Ernesciak</b><br>
        <span>Nieniszczącej wyglansowaniami debetujcie palu bezwładnieję dotropionych szabelkówkom płynni pociskowi dziwłach .</span><br>
        <small class="text-success">upvote</small>
        </div>
    </div> 

</div>


<form class="mt-3">
  <div class="form-group">
    <label for="commentTA">Comments about this auction</label>
    <textarea class="form-control" id="commentTA" rows="3"></textarea>
    <button onclick="submitComment()" class="btn-primary btn" type="button">Post comment</button>
  </div>
</form>


</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script>

 // TIMER SECTION ///
let endsAt = "{{auction.endsAt | date('U')}}";
let timerElement = document.getElementById('timer');

auctionTimer();
function auctionTimer()
{
    timerElement.innerHTML = secondsToHms(endsAt-(Math.round(Date.now()/1000)));
    if(endsAt-(Math.round(Date.now()/1000))> 0)
        setTimeout(auctionTimer, 500)
    else
        {
            timerElement.innerHTML = "Auction ended {{auction.endsAt|ago}}.";
            $("#offerForm").toggleClass('d-none');
        }
}

function secondsToHms(d) {
    d = Number(d);
    let da = Math.floor(d / 86400);
    let h = Math.floor(d % 86400 / 3600);
    let m = Math.floor(d % 86400 % 3600 / 60);
    let s = Math.floor(d % 86400 % 3600 % 60);

    let daDisplay = (da < 10 ? "0" : "") + da + ":";
    let hDisplay = (h < 10 ? "0" : "") + h + ":";
    let mDisplay = (m < 10 ? "0" : "") + m + ":";
    let sDisplay = (s < 10 ? "0" : "") + s;
    return daDisplay + hDisplay + mDisplay + sDisplay; 
}
 // TIMER SECTION ///



 // VALIDATE OFFER ///
$('#offerForm').validate(
    {
        submitHandler: function(form) 
        {
            makeOffer();
        }
    }
)
 // VALIDATE OFFER ///



 // OFFER AJAX CALL ///
function makeOffer()
{
    if({% if app.user %}true{% else %}false{% endif %})
    {
        let offerValue = document.getElementById('offerInput').value;
        let url = "{{path ('makeOffer') }}";

        $.ajax({
            url: url,
            method: "post", 
            data: JSON.stringify({'offerValue': offerValue*100,
                'auctionId' : {{auction.id}} }) 
            })
        .done(res => 
        { 
            console.log(res);
            if(res.errorsBody != null)
            {
                document.getElementById('backendErrors').innerHTML = res.errorsBody;
            }
            else
            {
                let container = document.createElement('div');
                container.innerHTML = '<b>Emis offers '+offerValue+' PLN</b> triggered at date <br>';
                document.getElementById('offers').prepend(container);
            }
        });
    }
    else
    {
        $('#exampleModalCenter').modal('show');
    }
}
 // OFFER AJAX CALL ///


 // POST COMMENT AJAX CALL ///
function submitComment()
{
    if({% if app.user %}true{% else %}false{% endif %})
    {
        let url = "{{path ('postComment') }}";

        $.ajax({
            url: url,
            method: "post", 
            data: JSON.stringify(
                {'content': $("#commentTA").val(),
                'auctionId': {{auction.id}}}) 
            })
        .done(res => 
        { 
            console.log(res);
        });
    }
    else
    {
        $('#exampleModalCenter').modal('show');
    }
}
 // POST COMMENT AJAX CALL ///

</script>
{% endblock %}